{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div style="max-width: 1400px; margin: 20px auto; padding: 20px;">
    <h1 style="color: #1e40af; margin-bottom: 30px;">🎯 Market Control Center</h1>
    
    <!-- Mode Toggle Section -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
        <h2 style="color: white; margin-bottom: 20px;">🔄 Price Update Mode</h2>
        
        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; margin-bottom: 10px; font-size: 14px;">Current Mode:</label>
                <div id="current-mode" style="font-size: 24px; font-weight: bold;">
                    {% if use_real_prices %}
                        📈 REAL MARKET DATA
                    {% else %}
                        🎲 SIMULATED PRICES
                    {% endif %}
                </div>
            </div>
            
            <button id="toggle-mode-btn" onclick="toggleMode()"
                    style="padding: 15px 30px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                Switch Mode
            </button>
        </div>
        
        <div style="font-size: 14px; opacity: 0.9; margin-top: 20px;">
            <strong>Real Market:</strong> Prices from Yahoo Finance (live stock data)<br>
            <strong>Simulated:</strong> Random price fluctuations (±2% volatility)
        </div>
    </div>
    
    <!-- Quick Actions Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <!-- Fetch Real Prices -->
        <div style="background: #10b981; color: white; padding: 30px; border-radius: 10px; text-align: center;">
            <h3 style="color: white; margin-bottom: 15px;">📈 Real Market Update</h3>
            <button onclick="fetchRealPrices()" 
                    style="padding: 15px 40px; background: white; color: #10b981; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                Fetch Live Prices Now
            </button>
            <p style="margin-top: 10px; font-size: 12px; opacity: 0.9;">Updates from Yahoo Finance</p>
        </div>
        
        <!-- Simulated Update -->
        <div style="background: #f59e0b; color: white; padding: 30px; border-radius: 10px; text-align: center;">
            <h3 style="color: white; margin-bottom: 15px;">🎲 Random Fluctuation</h3>
            <button onclick="simulateChanges()" 
                    style="padding: 15px 40px; background: white; color: #f59e0b; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                Randomize Prices Now
            </button>
            <p style="margin-top: 10px; font-size: 12px; opacity: 0.9;">±2% random changes</p>
        </div>
        
        <!-- Market Events Disabled Temporarily -->
        <div style="background: #6b7280; color: white; padding: 30px; border-radius: 10px; text-align: center; opacity: 0.6;">
            <h3 style="color: white; margin-bottom: 15px;">📰 Market Events</h3>
            <div style="display: inline-block; padding: 15px 40px; background: #374151; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold;">
                Coming Soon
            </div>
            <p style="margin-top: 10px; font-size: 12px; opacity: 0.9;">Feature temporarily disabled</p>
        </div>
    </div>
    
    <!-- Sector Control -->
    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 30px; margin-bottom: 30px;">
        <h2 style="color: #1e40af; margin-bottom: 20px;">📊 Sector-Based Control</h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Select Sector:</label>
            <select id="sector-select" style="width: 100%; max-width: 400px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                <option value="">-- All Sectors --</option>
                {% for sector in sectors %}
                <option value="{{ sector }}">{{ sector }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <button onclick="adjustSector(5)" style="padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                📈 +5%
            </button>
            <button onclick="adjustSector(10)" style="padding: 15px; background: #059669; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                🚀 +10%
            </button>
            <button onclick="adjustSector(-5)" style="padding: 15px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                📉 -5%
            </button>
            <button onclick="adjustSector(-10)" style="padding: 15px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                💥 -10%
            </button>
        </div>
        
        <div style="margin-top: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Custom Percentage:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="number" id="custom-percent" placeholder="e.g., 7.5 or -3.2" step="0.1" 
                       style="flex: 1; max-width: 200px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                <button onclick="applyCustomPercent()" style="padding: 10px 30px; background: #8b5cf6; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    Apply Custom %
                </button>
            </div>
        </div>
    </div>
    
    <!-- Status Messages -->
    <div id="status-message" style="display: none; padding: 20px; border-radius: 8px; margin-bottom: 20px;"></div>
    
    <!-- Quick Links -->
    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
        <a href="{% url 'admin:app1_stock_changelist' %}" style="color: #2563eb; text-decoration: none; font-weight: bold; padding: 10px 20px; background: #eff6ff; border-radius: 8px;">
            📊 Manage Stocks
        </a>
        <span style="color: #6b7280; text-decoration: none; font-weight: bold; padding: 10px 20px; background: #f3f4f6; border-radius: 8px; opacity: 0.6; cursor: not-allowed;">
            📰 Market Events (Coming Soon)
        </span>
        <a href="{% url 'admin:index' %}" style="color: #2563eb; text-decoration: none; font-weight: bold; padding: 10px 20px; background: #eff6ff; border-radius: 8px;">
            ← Back to Admin
        </a>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function showStatus(message, type) {
    const el = document.getElementById('status-message');
    el.textContent = message;
    el.style.display = 'block';
    el.style.background = type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : '#dbeafe';
    el.style.color = type === 'success' ? '#065f46' : type === 'error' ? '#991b1b' : '#1e40af';
    setTimeout(() => el.style.display = 'none', 5000);
}

function toggleMode() {
    const btn = document.getElementById('toggle-mode-btn');
    btn.disabled = true;
    btn.textContent = 'Switching...';
    
    fetch('/api/toggle-price-mode', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        showStatus(data.message, 'success');
        setTimeout(() => location.reload(), 1000);
    })
    .catch(err => {
        showStatus('Error toggling mode', 'error');
        btn.disabled = false;
        btn.textContent = 'Switch Mode';
    });
}

function fetchRealPrices() {
    showStatus('Fetching live prices from Yahoo Finance...', 'info');
    fetch('/api/update-prices-real', { method: 'POST', headers: {'X-CSRFToken': csrftoken} })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showStatus(`✅ Updated ${data.updated_count} stocks with real market data!`, 'success');
            } else {
                showStatus('❌ Error: ' + data.error, 'error');
            }
        });
}

function simulateChanges() {
    showStatus('Applying random price changes...', 'info');
    fetch('/api/update-prices', { method: 'POST', headers: {'X-CSRFToken': csrftoken} })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showStatus(`✅ Randomized ${data.updated_count} stock prices!`, 'success');
            } else {
                showStatus('❌ Error: ' + data.error, 'error');
            }
        });
}

function adjustSector(percentage) {
    const sector = document.getElementById('sector-select').value;
    if (!sector) {
        showStatus('⚠️ Please select a sector first', 'error');
        return;
    }
    
    showStatus(`Adjusting ${sector} sector by ${percentage > 0 ? '+' : ''}${percentage}%...`, 'info');
    
    fetch('/api/adjust-sector', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ sector: sector, percentage: percentage })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showStatus(`✅ ${data.message}`, 'success');
        } else {
            showStatus('❌ Error: ' + data.error, 'error');
        }
    });
}

function applyCustomPercent() {
    const sector = document.getElementById('sector-select').value;
    const percentage = parseFloat(document.getElementById('custom-percent').value);
    
    if (isNaN(percentage)) {
        showStatus('⚠️ Please enter a valid percentage', 'error');
        return;
    }
    
    if (!sector) {
        showStatus('⚠️ Please select a sector first', 'error');
        return;
    }
    
    showStatus(`Adjusting ${sector} sector by ${percentage > 0 ? '+' : ''}${percentage}%...`, 'info');
    
    fetch('/api/adjust-sector', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ sector: sector, percentage: percentage })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showStatus(`✅ ${data.message}`, 'success');
            document.getElementById('custom-percent').value = '';
        } else {
            showStatus('❌ Error: ' + data.error, 'error');
        }
    });
}
</script>
{% endblock %}
